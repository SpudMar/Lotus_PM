// Lotus PM - Prisma Schema
// All table names are module-prefixed per coding conventions.
// All financial amounts stored as Int (cents) — never Float.
// Soft deletes only — never hard delete financial or participant records.
// REQ-016: Encryption at rest handled by AWS RDS + application layer.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// CORE MODULE — Authentication, Users, Audit
// ─────────────────────────────────────────────

model CoreUser {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  role          CoreRole  @default(ASSISTANT)
  isActive      Boolean   @default(true)
  mfaEnabled    Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  // Auth relations (NextAuth)
  accounts      CoreAccount[]
  sessions      CoreSession[]

  // Audit trail — every action this user takes
  auditLogs     CoreAuditLog[]

  // Business relations
  assignedParticipants CrmParticipant[] @relation("AssignedPlanManager")
  approvedInvoices     InvInvoice[]     @relation("ApprovedBy")
  rejectedInvoices     InvInvoice[]     @relation("RejectedBy")
  submittedClaims      ClmClaim[]       @relation("ClaimSubmittedBy")
  outcomeClaims        ClmClaim[]       @relation("ClaimOutcomeBy")
  commLogs             CrmCommLog[]
  notifications        NtfNotification[]

  @@map("core_users")
}

enum CoreRole {
  DIRECTOR
  PLAN_MANAGER
  ASSISTANT
  PARTICIPANT
}

model CoreAccount {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user CoreUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("core_accounts")
}

model CoreSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user CoreUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("core_sessions")
}

model CoreVerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("core_verification_tokens")
}

model CoreAuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // e.g. "invoice.approved", "participant.created"
  resource   String   // e.g. "invoice", "participant"
  resourceId String
  before     Json?    // State before change (no PII in logs — REQ-017)
  after      Json?    // State after change
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user CoreUser @relation(fields: [userId], references: [id])

  @@index([resource, resourceId])
  @@index([userId])
  @@index([createdAt])
  @@map("core_audit_logs")
}

// ─────────────────────────────────────────────
// CRM MODULE — Participants, Providers, Comms
// ─────────────────────────────────────────────

model CrmParticipant {
  id                String    @id @default(cuid())
  ndisNumber        String    @unique
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  email             String?
  phone             String?
  address           String?
  suburb            String?
  state             String?
  postcode          String?

  // Plan manager assignment
  assignedToId      String?
  assignedTo        CoreUser? @relation("AssignedPlanManager", fields: [assignedToId], references: [id])

  // Emergency contact
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRel   String?

  // Metadata
  isActive          Boolean   @default(true)
  onboardedAt       DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? // Soft delete — REQ-010

  // Relations
  plans             PlanPlan[]
  invoices          InvInvoice[]
  claims            ClmClaim[]
  commLogs          CrmCommLog[]
  documents         DocDocument[]

  @@index([ndisNumber])
  @@index([assignedToId])
  @@map("crm_participants")
}

model CrmProvider {
  id              String    @id @default(cuid())
  name            String
  abn             String    @unique
  email           String?
  phone           String?
  address         String?

  // NDIS provider registration
  ndisRegistered  Boolean   @default(true)
  registrationNo  String?

  // Bank details for ABA payment files
  bankBsb         String?
  bankAccount     String?
  bankAccountName String?

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // Relations
  invoices        InvInvoice[]
  commLogs        CrmCommLog[]

  @@index([abn])
  @@map("crm_providers")
}

model CrmCommLog {
  id            String           @id @default(cuid())
  type          CommType
  direction     CommDirection    @default(OUTBOUND)
  subject       String?
  body          String           @db.Text
  participantId String?
  providerId    String?
  userId        String           // Staff member who logged this

  participant   CrmParticipant?  @relation(fields: [participantId], references: [id])
  provider      CrmProvider?     @relation(fields: [providerId], references: [id])
  user          CoreUser         @relation(fields: [userId], references: [id])

  occurredAt    DateTime         @default(now())
  createdAt     DateTime         @default(now())

  @@index([participantId])
  @@index([providerId])
  @@map("crm_comm_logs")
}

enum CommType {
  EMAIL
  PHONE
  SMS
  IN_PERSON
  PORTAL_MESSAGE
  NOTE
}

enum CommDirection {
  INBOUND
  OUTBOUND
  INTERNAL
}

// ─────────────────────────────────────────────
// PLAN MODULE — Plans, Budgets, Spending
// ─────────────────────────────────────────────

model PlanPlan {
  id              String     @id @default(cuid())
  participantId   String
  participant     CrmParticipant @relation(fields: [participantId], references: [id])

  // Plan dates
  startDate       DateTime
  endDate         DateTime
  reviewDate      DateTime?

  // PACE plan reference — populated manually or via B2B sync when available
  prodaPlanId     String?    @unique

  status          PlanStatus @default(ACTIVE)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  budgetLines     PlanBudgetLine[]
  invoices        InvInvoice[]

  @@index([participantId])
  @@index([status])
  @@map("plan_plans")
}

enum PlanStatus {
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  UNDER_REVIEW
  INACTIVE
}

model PlanBudgetLine {
  id              String   @id @default(cuid())
  planId          String
  plan            PlanPlan @relation(fields: [planId], references: [id])

  // NDIS support category (01-15)
  categoryCode    String
  categoryName    String

  // All amounts in cents (Int) — REQ: never floats for money
  allocatedCents  Int
  spentCents      Int      @default(0)
  reservedCents   Int      @default(0) // Claimed but not yet paid

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  invoiceLines    InvInvoiceLine[]

  @@unique([planId, categoryCode])
  @@index([planId])
  @@map("plan_budget_lines")
}

// ─────────────────────────────────────────────
// INVOICE MODULE — Processing Pipeline
// ─────────────────────────────────────────────

model InvInvoice {
  id              String        @id @default(cuid())
  participantId   String
  providerId      String
  planId          String?

  participant     CrmParticipant @relation(fields: [participantId], references: [id])
  provider        CrmProvider   @relation(fields: [providerId], references: [id])
  plan            PlanPlan?     @relation(fields: [planId], references: [id])

  // Invoice details
  invoiceNumber   String
  invoiceDate     DateTime
  receivedAt      DateTime      @default(now())

  // Amounts in cents
  subtotalCents   Int
  gstCents        Int           @default(0)
  totalCents      Int

  // AI extraction
  aiConfidence    Float?        // 0.0–1.0
  aiExtractedAt   DateTime?
  aiRawData       Json?         // Full Textract response

  // S3 storage — REQ-011: stored in ap-southeast-2
  s3Key           String?       // Key in S3 bucket
  s3Bucket        String?

  // Processing state
  status          InvStatus     @default(RECEIVED)
  approvedById    String?
  approvedAt      DateTime?
  rejectedById    String?
  rejectedAt      DateTime?
  rejectionReason String?

  approvedBy      CoreUser?     @relation("ApprovedBy", fields: [approvedById], references: [id])
  rejectedBy      CoreUser?     @relation("RejectedBy", fields: [rejectedById], references: [id])

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?     // Soft delete — REQ-010

  lines           InvInvoiceLine[]
  claims          ClmClaim[]

  @@index([participantId])
  @@index([providerId])
  @@index([status])
  @@index([receivedAt])
  @@map("inv_invoices")
}

enum InvStatus {
  RECEIVED
  PROCESSING
  PENDING_REVIEW
  APPROVED
  REJECTED
  CLAIMED
  PAID
}

model InvInvoiceLine {
  id              String          @id @default(cuid())
  invoiceId       String
  invoice         InvInvoice      @relation(fields: [invoiceId], references: [id])

  budgetLineId    String?
  budgetLine      PlanBudgetLine? @relation(fields: [budgetLineId], references: [id])

  // NDIS support item details
  supportItemCode String          // e.g. "15_042_0128_1_3"
  supportItemName String
  categoryCode    String
  serviceDate     DateTime
  quantity        Float
  unitPriceCents  Int
  totalCents      Int
  gstCents        Int             @default(0)

  // Validation
  isPriceGuideCompliant Boolean   @default(true)
  priceGuideMaxCents    Int?      // Max allowed per price guide

  claimLines      ClmClaimLine[]

  @@index([invoiceId])
  @@map("inv_invoice_lines")
}

// ─────────────────────────────────────────────
// CLAIMS MODULE — NDIS Claims
// Portal Mode: staff submit via PACE portal, record references + outcomes here.
// B2B Mode (future): PACE API auto-submits claims, polls outcomes.
// prodaXxx fields are optional — populated manually now, auto-populated with B2B.
// ─────────────────────────────────────────────

model ClmBatch {
  id              String        @id @default(cuid())
  batchNumber     String        @unique // e.g. "BATCH-2026-0001"

  // Totals
  claimCount      Int           @default(0)
  totalCents      Int           @default(0)
  approvedCents   Int           @default(0)

  status          ClmBatchStatus @default(DRAFT)

  // Who submitted and when
  submittedById   String?
  submittedAt     DateTime?
  completedAt     DateTime?
  notes           String?

  // PACE reference — entered manually (Portal Mode) or auto-populated (B2B Mode)
  prodaBatchId    String?       @unique

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  claims          ClmClaim[]

  @@index([status])
  @@map("clm_batches")
}

enum ClmBatchStatus {
  DRAFT          // Collecting claims
  SUBMITTED      // Submitted to NDIA (manually via portal or future B2B)
  PROCESSING     // NDIA is processing
  COMPLETED      // All outcomes received
  PARTIALLY_COMPLETED // Some outcomes received
}

model ClmClaim {
  id              String      @id @default(cuid())
  claimReference  String      @unique // e.g. "CLM-2026-0001"
  invoiceId       String
  invoice         InvInvoice  @relation(fields: [invoiceId], references: [id])

  // Participant — denormalised for easier querying/filtering
  participantId   String
  participant     CrmParticipant @relation(fields: [participantId], references: [id])

  // Batch grouping (optional — claims can exist outside a batch)
  batchId         String?
  batch           ClmBatch?   @relation(fields: [batchId], references: [id])

  // PACE references — entered manually (Portal Mode) or auto-populated (B2B Mode)
  prodaClaimId    String?     @unique
  prodaReference  String?

  // Amounts in cents
  claimedCents    Int
  approvedCents   Int         @default(0)

  // Claim lifecycle
  status          ClmStatus   @default(PENDING)
  submittedById   String?
  submittedBy     CoreUser?   @relation("ClaimSubmittedBy", fields: [submittedById], references: [id])
  submittedAt     DateTime?
  outcomeAt       DateTime?
  outcomeNotes    String?
  outcomeById     String?
  outcomeBy       CoreUser?   @relation("ClaimOutcomeBy", fields: [outcomeById], references: [id])

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  lines           ClmClaimLine[]
  payments        BnkPayment[]

  @@index([status])
  @@index([invoiceId])
  @@index([participantId])
  @@index([batchId])
  @@map("clm_claims")
}

enum ClmStatus {
  PENDING        // Created, not yet submitted
  SUBMITTED      // Submitted to NDIA
  APPROVED       // Fully approved by NDIA
  REJECTED       // Rejected by NDIA
  PARTIAL        // Partially approved
  PAID           // Provider paid
}

model ClmClaimLine {
  id              String        @id @default(cuid())
  claimId         String
  claim           ClmClaim      @relation(fields: [claimId], references: [id])

  // Maps to invoice line
  invoiceLineId   String?
  invoiceLine     InvInvoiceLine? @relation(fields: [invoiceLineId], references: [id])

  // NDIS support item details (copied from invoice line for claim record)
  supportItemCode String
  supportItemName String
  categoryCode    String
  serviceDate     DateTime
  quantity        Float
  unitPriceCents  Int
  totalCents      Int
  gstCents        Int           @default(0)

  // Outcome per line (NDIA may approve/reject individual lines)
  approvedCents   Int           @default(0)
  status          ClmLineStatus @default(PENDING)
  outcomeNotes    String?

  @@index([claimId])
  @@map("clm_claim_lines")
}

enum ClmLineStatus {
  PENDING
  APPROVED
  REJECTED
  PARTIAL
}

// ─────────────────────────────────────────────
// BANKING MODULE — ABA Files, Reconciliation
// ─────────────────────────────────────────────

model BnkPayment {
  id            String     @id @default(cuid())
  claimId       String
  claim         ClmClaim   @relation(fields: [claimId], references: [id])

  // CBA ABA file details
  abaFileId     String?
  abaFile       BnkAbaFile? @relation(fields: [abaFileId], references: [id])

  amountCents   Int
  bsb           String
  accountNumber String
  accountName   String
  reference     String?

  status        BnkPaymentStatus @default(PENDING)
  processedAt   DateTime?

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([status])
  @@map("bnk_payments")
}

enum BnkPaymentStatus {
  PENDING
  IN_ABA_FILE
  SUBMITTED_TO_BANK
  CLEARED
  FAILED
  REVERSED
}

model BnkAbaFile {
  id            String     @id @default(cuid())
  filename      String
  s3Key         String

  // Batch totals
  totalCents    Int
  paymentCount  Int

  // CBA CommBiz reference
  bankReference String?
  submittedAt   DateTime?
  clearedAt     DateTime?

  createdAt     DateTime   @default(now())

  payments      BnkPayment[]

  @@map("bnk_aba_files")
}

// ─────────────────────────────────────────────
// DOCUMENTS MODULE — File Storage
// ─────────────────────────────────────────────

model DocDocument {
  id            String      @id @default(cuid())
  participantId String?
  participant   CrmParticipant? @relation(fields: [participantId], references: [id])

  name          String
  description   String?
  mimeType      String
  sizeBytes     Int
  s3Key         String
  s3Bucket      String

  // Versioning
  version       Int         @default(1)
  previousId    String?     // Points to prior version

  uploadedById  String
  createdAt     DateTime    @default(now())

  @@index([participantId])
  @@map("doc_documents")
}

// ─────────────────────────────────────────────
// AUTOMATION MODULE — Rules, Triggers, Actions
// ─────────────────────────────────────────────

model AutoRule {
  id              String          @id @default(cuid())
  name            String
  description     String?
  isActive        Boolean         @default(true)

  // What kicks this off
  triggerType     AutoTriggerType
  triggerEvent    String?         // e.g. "lotus-pm.invoices.approved" (EVENT type)
  cronExpression  String?         // e.g. "0 9 * * *" (SCHEDULE type)

  // Conditions and actions stored as JSON arrays
  // See src/lib/modules/automation/types.ts for shapes
  conditions      Json            // AutoCondition[]
  actions         Json            // AutoAction[]

  // Stats
  lastTriggeredAt DateTime?
  executionCount  Int             @default(0)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  deletedAt       DateTime?       // Soft delete

  executions      AutoExecutionLog[]

  @@index([triggerType])
  @@index([isActive])
  @@map("auto_rules")
}

enum AutoTriggerType {
  EVENT    // Triggered by an EventBridge event
  SCHEDULE // Triggered on a cron schedule
}

model AutoExecutionLog {
  id           String              @id @default(cuid())
  ruleId       String
  rule         AutoRule            @relation(fields: [ruleId], references: [id])

  triggeredBy  String              // event name, "schedule", or "manual"
  context      Json                // The trigger payload

  result       AutoExecutionResult
  actionsRun   Int                 @default(0)
  errorMessage String?
  durationMs   Int?

  executedAt   DateTime            @default(now())

  @@index([ruleId])
  @@index([executedAt])
  @@map("auto_execution_logs")
}

enum AutoExecutionResult {
  SUCCESS  // All conditions met, all actions completed
  SKIPPED  // Conditions not met — rule did not fire
  FAILED   // Error during condition evaluation or action execution
}

// ─────────────────────────────────────────────
// NOTIFICATIONS MODULE — In-app, Email, SMS
// ─────────────────────────────────────────────

model NtfNotification {
  id          String          @id @default(cuid())
  userId      String          // Recipient staff user
  user        CoreUser        @relation(fields: [userId], references: [id])

  // Notification content
  type        NtfType
  title       String
  body        String
  link        String?         // Optional deep-link path, e.g. "/invoices?id=xxx"

  // Categorisation
  category    NtfCategory
  priority    NtfPriority     @default(NORMAL)

  // Read / dismissed tracking
  readAt      DateTime?
  dismissedAt DateTime?

  // Delivery tracking (for email/SMS)
  channels    NtfChannel[]    @default([IN_APP])
  emailSentAt DateTime?
  smsSentAt   DateTime?

  createdAt   DateTime        @default(now())

  @@index([userId, readAt])
  @@index([userId, createdAt])
  @@index([category])
  @@map("ntf_notifications")
}

enum NtfType {
  INFO
  WARNING
  ACTION_REQUIRED
  SUCCESS
}

enum NtfCategory {
  INVOICE       // Invoice received, needs review, approved, rejected
  CLAIM         // Claim submitted, outcome received
  PAYMENT       // Payment pending, cleared
  PLAN          // Plan expiring, budget threshold
  COMPLIANCE    // NDIS processing deadline approaching
  SYSTEM        // System-level notifications
}

enum NtfPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NtfChannel {
  IN_APP
  EMAIL
  SMS
}
